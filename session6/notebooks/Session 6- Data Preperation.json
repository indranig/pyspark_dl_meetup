{"paragraphs":[{"text":"%spark\n\nimport collection.JavaConverters._","dateUpdated":"2017-08-16T21:31:19+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nimport collection.JavaConverters._\n"}]},"apps":[],"jobName":"paragraph_1502918898348_1888112790","id":"20170510-195936_662415991","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:4872","user":"anonymous","dateFinished":"2017-08-16T21:31:37+0000","dateStarted":"2017-08-16T21:31:20+0000"},{"text":"%pyspark\n\nimport numpy as np","dateUpdated":"2017-08-16T21:31:20+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898355_1899270508","id":"20170510-203853_921045072","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4873","user":"anonymous","dateFinished":"2017-08-16T21:31:37+0000","dateStarted":"2017-08-16T21:31:20+0000"},{"text":"%spark\n\n// Pull in the data from a file.\nval full_data_frame = sqlc.read.format(\"csv\").option(\"header\", true).load(\"/data-sets/transactions_mid.csv\")\nval proper_data_frame = full_data_frame.selectExpr(\"CAST(id AS LONG) id\", \"CAST(category AS LONG) category\", \"CAST(date AS DATE) date\")","dateUpdated":"2017-08-16T21:31:20+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nfull_data_frame: org.apache.spark.sql.DataFrame = [id: string, chain: string ... 9 more fields]\n\nproper_data_frame: org.apache.spark.sql.DataFrame = [id: bigint, category: bigint ... 1 more field]\n"}]},"apps":[],"jobName":"paragraph_1502918898357_1896962015","id":"20170510-171530_1117999144","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4874","user":"anonymous","dateFinished":"2017-08-16T21:31:39+0000","dateStarted":"2017-08-16T21:31:21+0000"},{"text":"%spark\n\n// Get an RDD with each column cast as the required data type (Long, Long, Long).\nval raw_rdd = proper_data_frame.rdd.map { row =>\n    (row.getLong(0).asInstanceOf[java.lang.Long], row.getDate(2).getTime.asInstanceOf[java.lang.Long], row.getLong(1).asInstanceOf[java.lang.Long])\n} ","dateUpdated":"2017-08-16T21:31:20+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nraw_rdd: org.apache.spark.rdd.RDD[(Long, Long, Long)] = MapPartitionsRDD[11] at map at <console>:35\n"}]},"apps":[],"jobName":"paragraph_1502918898358_1898116262","id":"20170510-172715_1461894513","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4875","user":"anonymous","dateFinished":"2017-08-16T21:31:40+0000","dateStarted":"2017-08-16T21:31:38+0000"},{"text":"%spark\n\n// Find which items show up infrequently (less than 10 times).\nval infrequent_items = raw_rdd.map { case (id, date, item) =>\n    (item, 1)\n}.reduceByKey(_+_).filter { case (item, instances) => \n    instances < 10 \n}.keys.collect()","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\ninfrequent_items: Array[Long] = Array(4904, 1110, 7332, 1724, 3404, 2214, 3710, 2202, 9126, 3320, 9724, 6706, 2718, 9746, 9782, 6904, 9786, 208, 9742, 4406, 4408, 7004, 2724, 7220, 2122, 9106, 5612, 5566, 3902, 9132, 9802, 7360, 7306, 6704, 9130, 6708, 9206, 1008, 7534, 4706, 5622, 2502, 3510, 7314, 2926, 7802, 7318, 510, 7204, 6702, 7324, 7404, 9108, 9770, 1204, 2922, 7326, 2216, 9214, 7408, 7410, 6333, 4407, 2715, 7533, 9133, 9743, 799, 4405, 9771, 1505, 3513, 1399, 9735, 919, 5699, 423, 7329, 9107, 7361, 9747, 2703, 9213, 3011, 9763, 7215, 6329, 1605, 7115, 2723, 3613, 9103, 3199, 7505, 1009, 2711, 1799, 209, 399, 6909, 9731, 9781, 2611, 2899, 7349, 3321, 3103, 9713, 9803, 9639, 3507, 1705, 9905, 1897, 837, 7325, 7111, 6705, 9207, 9741, 3699, 9733, 2621, 207, 9801, 3605)\n"}]},"apps":[],"jobName":"paragraph_1502918898360_1895807768","id":"20170510-174011_1072726001","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4876","user":"anonymous","dateFinished":"2017-08-16T21:31:43+0000","dateStarted":"2017-08-16T21:31:40+0000"},{"text":"%spark\n\n// Filter out infrequent items.\nval filtered_rdd = raw_rdd.filter { case (id, date, item) =>\n    !infrequent_items.contains(item)\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nfiltered_rdd: org.apache.spark.rdd.RDD[(Long, Long, Long)] = MapPartitionsRDD[16] at filter at <console>:39\n"}]},"apps":[],"jobName":"paragraph_1502918898361_1895423019","id":"20170510-181909_152380770","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4877","user":"anonymous","dateFinished":"2017-08-16T21:31:44+0000","dateStarted":"2017-08-16T21:31:40+0000"},{"text":"%spark\n\n// Create a new index for each item.\nval new_indexed_item_rdd = filtered_rdd.map { case(id, date, item) =>\n    item\n}.distinct.map((1,_)).groupByKey.values.flatMap { items =>\n    items.zipWithIndex\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nnew_indexed_item_rdd: org.apache.spark.rdd.RDD[(Long, Int)] = MapPartitionsRDD[24] at flatMap at <console>:43\n"}]},"apps":[],"jobName":"paragraph_1502918898363_1896192517","id":"20170510-184022_1808649945","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4878","user":"anonymous","dateFinished":"2017-08-16T21:31:44+0000","dateStarted":"2017-08-16T21:31:44+0000"},{"text":"%spark\n\n// Key RDD by the item.\nval left_rdd = filtered_rdd.map { case (id, date, item) =>\n    (item, (id, date))\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nleft_rdd: org.apache.spark.rdd.RDD[(Long, (Long, Long))] = MapPartitionsRDD[25] at map at <console>:41\n"}]},"apps":[],"jobName":"paragraph_1502918898364_1894268773","id":"20170510-195630_931160979","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4879","user":"anonymous","dateFinished":"2017-08-16T21:31:45+0000","dateStarted":"2017-08-16T21:31:44+0000"},{"text":"%spark\n\n// Left outer join the new indexed items with the filtered items.\nval joined_rdd = left_rdd.leftOuterJoin(new_indexed_item_rdd).map { case (old_item_id, ((id, date), new_item_id_option)) =>\n    (id, date, new_item_id_option.get)\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\njoined_rdd: org.apache.spark.rdd.RDD[(Long, Long, Int)] = MapPartitionsRDD[29] at map at <console>:45\n"}]},"apps":[],"jobName":"paragraph_1502918898366_1895038270","id":"20170510-200507_876524725","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4880","user":"anonymous","dateFinished":"2017-08-16T21:31:45+0000","dateStarted":"2017-08-16T21:31:45+0000"},{"text":"%spark\n\n// Formate RDD to ((id, data), item).\nval id_date_keyed_rdd = joined_rdd.map { case (id, date, item) =>\n    ((id, date), item)\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nid_date_keyed_rdd: org.apache.spark.rdd.RDD[((Long, Long), Int)] = MapPartitionsRDD[30] at map at <console>:47\n"}]},"apps":[],"jobName":"paragraph_1502918898367_1894653522","id":"20170510-174650_1059407894","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4881","user":"anonymous","dateFinished":"2017-08-16T21:31:45+0000","dateStarted":"2017-08-16T21:31:45+0000"},{"text":"%spark\n\n// Group and filter the RDD.\nval rdd = id_date_keyed_rdd.groupByKey.map { case ((id, date), items) =>\n    (id, (date, items))\n}.groupByKey.filter(_._2.size >= 4).mapValues(_.toSeq.sortWith(_._1 < _._1))","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nrdd: org.apache.spark.rdd.RDD[(Long, Seq[(Long, Iterable[Int])])] = MapPartitionsRDD[35] at mapValues at <console>:51\n"}]},"apps":[],"jobName":"paragraph_1502918898369_1880033063","id":"20170510-182431_1330877901","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4882","user":"anonymous","dateFinished":"2017-08-16T21:31:46+0000","dateStarted":"2017-08-16T21:31:45+0000"},{"text":"%spark\n\n// Convert to a Java RDD.\nval java_typed_rdd = rdd.map { case (id, baskets) =>\n    val java_baskets = baskets.map { case (date, items) =>\n        val java_items = items.asJava\n        Seq(date, java_items).asJava\n    }.asJava\n    Seq(id, java_baskets).asJava\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\njava_typed_rdd: org.apache.spark.rdd.RDD[java.util.List[Object]] = MapPartitionsRDD[36] at map at <console>:51\n"}]},"apps":[],"jobName":"paragraph_1502918898370_1881187310","id":"20170510-195243_736799608","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4883","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:46+0000"},{"text":"%spark\n\n// Pickle the data and prepare it for Python.\nval serialized_rdd = java_typed_rdd.mapPartitions { partition =>\n    val pickler_klass = Class.forName(\"org.apache.spark.api.python.SerDeUtil$AutoBatchedPickler\")\n    val constructor = pickler_klass.getConstructor(classOf[Iterator[Any]])\n    constructor.newInstance(partition).asInstanceOf[Iterator[Byte]]\n}.toJavaRDD","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"\nserialized_rdd: org.apache.spark.api.java.JavaRDD[Byte] = MapPartitionsRDD[37] at mapPartitions at <console>:53\n"}]},"apps":[],"jobName":"paragraph_1502918898371_1880802561","id":"20170510-202911_2121681603","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4884","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:47+0000"},{"text":"%spark\n\n// This is how Zeppelin allows us to transfere things between languages. \"z\" is the \"Zeppelin context\".\nfor(i <- 1 to 5) {\n    z.put(\"java_rdd\", serialized_rdd)\n}","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/scala","results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898372_1878878817","id":"20170510-203010_478860460","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4885","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:47+0000"},{"text":"%pyspark\n\n# NOTE: Take notice that we are now in Python Land!\n\n# We must get the RDD from the Zeppelin context.\njrdd = z.get(\"java_rdd\")","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898374_1879648314","id":"20170510-203147_2051050555","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4886","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:47+0000"},{"text":"%pyspark\n\n# Convert to a Python RDD.\nrdd = RDD(jrdd, sc)","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898375_1879263566","id":"20170510-203241_233675025","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4887","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:47+0000"},{"text":"%pyspark\n\n# Helper function to create baskets of items. \ndef make_numpy_basket(items):\n    truncated = map(lambda x: x+1, items[:50])\n    length = len(truncated)\n    if length < 50:\n        zeros = [0] * (50 - length)\n    else:\n        zeros = []\n    return [length] + truncated + zeros","dateUpdated":"2017-08-16T21:31:21+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898376_1877339821","id":"20170510-203711_1687977858","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4888","user":"anonymous","dateFinished":"2017-08-16T21:31:47+0000","dateStarted":"2017-08-16T21:31:47+0000"},{"text":"%pyspark\n\n# Helper function to format the date.\ndef make_numpy_date(date):\n    baskets = make_numpy_basket(date[1])\n    return [date[0]] + baskets","dateUpdated":"2017-08-16T21:31:22+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898377_1876955072","id":"20170510-204211_832117308","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4889","user":"anonymous","dateFinished":"2017-08-16T21:31:48+0000","dateStarted":"2017-08-16T21:31:48+0000"},{"text":"%pyspark\n\n# Hellper function to format the rows properly.\ndef make_numpy_row(row):\n    return map(lambda date:np.array([row[0]] + make_numpy_date(date)), row[1])","dateUpdated":"2017-08-16T21:31:22+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898379_1877724570","id":"20170510-204319_159630643","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4890","user":"anonymous","dateFinished":"2017-08-16T21:31:48+0000","dateStarted":"2017-08-16T21:31:48+0000"},{"text":"%pyspark\n\n# Turn the RDD into a Numpy formatted array.\nnp_rdd = rdd.flatMap(make_numpy_row)","dateUpdated":"2017-08-16T21:31:22+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1502918898380_1875800825","id":"20170510-204540_1521042492","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:4891","user":"anonymous","dateFinished":"2017-08-16T21:31:48+0000","dateStarted":"2017-08-16T21:31:48+0000"},{"text":"%pyspark\n","dateUpdated":"2017-08-16T21:31:22+0000","config":{"enabled":true,"editorMode":"ace/mode/python","results":{},"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1502918898381_1875416077","id":"20170815-182748_1651425551","dateCreated":"2017-08-16T21:28:18+0000","status":"FINISHED","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:4892","user":"anonymous"}],"name":"Session 6: Data Preperation","id":"2CQVCSU3Y","angularObjects":{"2CQ2WVPB8:shared_process":[],"2CQY9GPVB:shared_process":[],"2CTHTAZ8Q:shared_process":[],"2CQRPE8YV:shared_process":[],"2CQ23J7B7:shared_process":[],"2CTE15UEC:shared_process":[],"2CPZTGXMU:shared_process":[],"2CQE29AME:shared_process":[],"2CSHK6468:shared_process":[],"2CPRVQ996:shared_process":[],"2CRBS66AJ:shared_process":[],"2CSJNUU1H:shared_process":[],"2CTBJTBUE:shared_process":[],"2CSX7EW2R:shared_process":[],"2CS8KTAXE:shared_process":[],"2CQ5S3EZ5:shared_process":[],"2CQBN3T8T:shared_process":[],"2CR9EQGWV:shared_process":[],"2CTM3NQZE:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}